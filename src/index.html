<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="node_modules/webix/webix.css" type="text/css" charset="utf-8">
    <script src="node_modules/webix/webix.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="src/papaya.js"></script>
    <script type="text/javascript" src="src/sampleDataSets.js"></script>
    <link rel="stylesheet" type="text/css" href="css/papaya.css" />
    <script type="text/javascript" src="node_modules/jquery/dist/jquery.js"></script>
    <title>webix Papaya Viewer Integration</title>
</head>

<body>
    <script>
        /*This will need some work, but this allows me to create a new papaya viewer while using webix to control location by creating a prototype */
    webix.protoUI({
name: "webixPapaya",
$init: function(config) {
this.$view.innerHTML = "<div class='papaya' data-params='params'>";
    },
    defaults: {
    width: 800, //ideally these are dynamic
    height: 800
    }
    }, webix.ui.view);
    //this will be moved to a combo box or config at some point.. these are predefined color tables
    var papayaColorTables = ["Grayscale", "Spectrum", "Overlay (Positives)", "Overlay (Negatives)", "Hot-and-Cold", "Gold", "Red Overlay", "Green Overlay", "Blue Overlay"]
    //papaya.Container.startPapaya() <<< THIS ALSO NEEDS TO RUN AFTER CREATING THE DIV var leftPanel={ rows: [{ view: "template" , template: "TopPanel" }, { view: "template" , template: "MaskImagePanel" } ]}

var leftPanel = {
    rows: [
        { view: "template", template: "Controls" },
        
    ], gravity:0.1
}

var middlePanel = { view:"webixPapaya"}   

  // var baseImageControls = {
  //       rows: [
  //       {
  //       view: "slider",
  //       label: "baseImgSlider",
  //       value: "20",
  //       min: 0,
  //       max: 1,
  //       step: 0.05,
  //       labelWidth: 200,
  //       name: "s1",
  //       on: {
  //       "onChange": function(newv, oldv) {
  //       //so the volId refers to the order it's on the
  //           papayaContainers[0].viewer.screenVolumes[0].alpha = newv;
  //               papayaContainers[0].viewer.drawViewer(true, false);

  //                           }
  //           }       
  //       },
  //              {
  //           view: "combo",
  //           label: "baseImgColorTable",
  //           labelWidth: 2000,
  //           options: papayaColorTables,
  //           on: {
  //               "onChange": function(newv, oldv) {
  //                   webix.message(newv);

  //                   myViewer = papayaContainers[0].viewer;
  //                   //To Do.... Unclear why I need to pass myViewer to this
  //                   papayaContainers[0].viewer.screenVolumes[0].changeColorTable(myViewer, newv)
  //               }
  //           }
  //       },
  //       ]}


        function generateMaskControls( viewerId, imageId, imgName )
            {
                /* This will build a webix view to manipulate an image in papaya
                viewerId refers to the papayaViewer number, this starts at 0, but you can have multiple viewers in the same web page
                imageId refers to the layer, 0 is the base image, and then each additional overlay image goes from there, this is one of the things I need to sync*/


return {
        rows: [
        {
            type:"header", template: imgName


        },


        {
        view: "slider",
        label: "opacity",
        value: "1",
        min: 0,
        max: 1,
        step: 0.05,
        labelWidth: 200,
        inputWidth: 350,
        name: "s2",
        on: {
        "onChange": function(newv, oldv) {
            papayaContainers[viewerId].viewer.screenVolumes[imageId].alpha = newv;
                papayaContainers[viewerId].viewer.drawViewer(true, false);

                            }
            }       
        },
               {
            view: "combo",
            label: "LUT",
            //autowidth:true,//why does this screw it up so bad!
            labelWidth: 250,
            inputWidth: 400,
            options: papayaColorTables,
            on: {
                "onChange": function(newv, oldv) {
                    webix.message(newv);
                    myViewer = papayaContainers[viewerId].viewer;
                    //To Do.... Unclear why I need to pass myViewer to this
                    papayaContainers[viewerId].viewer.screenVolumes[imageId].changeColorTable(myViewer, newv)
                }
            }
        },
        ]}

            }


 var baseImageControls = generateMaskControls(0,0,'baseImage');


var firstOverlayControls = generateMaskControls(0,1,'firstOverlay')
var secondOverlayControls = generateMaskControls(0,2,'secondOverlay')


 // /{"min": 4, "max": 8, "lut": "Red Overlay"};



var rightPanel = {
    rows: [
        baseImageControls,
        firstOverlayControls,
        secondOverlayControls
    ], gravity:0.2
}

var  layout = { cols: [ leftPanel, {view:"resizer"},
                middlePanel, rightPanel]}


                //For now I am going to hard code some sample Images to render...

    var params = [];
    //I need to keep abstracting this... the lut/min/max can be inferred from the 
    //imageType
    mainImg = sampleDataSets["MNI_1mm"][0]["path"];
    maskImg = sampleDataSets["MNI_1mm"][1]["path"];
    secondMaskImg = sampleDataSets["MNI_1mm"][3]["path"];

 params["images"] = [mainImg, maskImg, secondMaskImg];



 //NUTS--- so the images array needs the full file path, but the
 //params below just needs the specific file name..

    params[maskImg] = {
        "screenMin": 1,
        "screenMax": 2,
        "min": 3,
        "max": 4,
        "lut": "Fire"
    };

    params["MNI152_T1_1mm_Hipp_mask_dil8.nii.gz"] = {
        "screenMin": 0,
        "screenMax": 2,
        "min": 0,
        "max": 2,
        
        "lut": "Green Overlay"
    };
 



webix.ready(function() {
        webix.ui(layout);
     papaya.Container.startPapaya() //Because of the way we insert the papaya to the DOM, we need to call this to initialize it
    $(".papaya-main-swap").click(function() {
         papaya.viewer.Viewer.prototype.rotateViews();
     });
    

    })


    </script>
    <button id="swap-slice" class="papaya-main-swap" type="button" style="display: block; top: 475px; left: 700px; position: relative;">Swap Main Slice</button>
    <script>
    // params = ['images', 'showControls', 'showControlBar', 'orthogonal', 'smoothDisplay', 'coordinate'];
    // params['images'] = [pathImg];
    // params['orthogonal'] = false;
    // params['smoothDisplay'] = false;
    // params['showControlBar'] = false;
    // params['showControls'] = false;
    // params.loadingComplete = () => {
    // this.startPapaya();
    // };

    // papayaContainers[0].viewer.toggleOverlay(1)  <<< TO DO >>>
    </script>
</body>

</html>